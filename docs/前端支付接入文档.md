# å‰ç«¯æ”¯ä»˜æ¥å…¥æ–‡æ¡£

## ğŸ“Œ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›é€šç”¨æ”¯ä»˜æ¥å£çš„æŠ€æœ¯è§„èŒƒï¼Œé€‚ç”¨äºæ‰€æœ‰éœ€è¦æ”¯ä»˜åŠŸèƒ½çš„é¡¹ç›®ï¼ˆå•†åŸã€æœåŠ¡ã€æ‰“èµã€ä¼šå‘˜ç­‰ï¼‰ã€‚

**API Base URL**: `https://api.{project}.chuchuang.work/api`
- Fans é¡¹ç›®: `https://api.fans.chuchuang.work/api`
- Work é¡¹ç›®: `https://api.work.chuchuang.work/api`
- Dating é¡¹ç›®: `https://api.dating.chuchuang.work/api`

**æœ€è¿‘æ›´æ–°**: 2025-12-20
- âœ… å‚æ•°è®¾è®¡ä¼˜åŒ–ï¼šæ‰å¹³åŒ–ç»“æ„ï¼ˆç§»é™¤ custom_meta åµŒå¥—ï¼‰
- âœ… å­—æ®µé‡å‘½åï¼šname â†’ titleï¼ˆç»Ÿä¸€å‘½åï¼‰
- âœ… æ–°å¢ 5 ç§è®¢å•ç±»å‹æ”¯æŒ
- âœ… å®Œå–„ä¼šå‘˜è®¢é˜…åŠŸèƒ½

---

## ğŸ”„ å®Œæ•´æ”¯ä»˜æµç¨‹

```
1. å‰ç«¯è°ƒç”¨åˆ›å»ºè®¢å•æ¥å£ (/payment/create)
   â†“
2. åç«¯åˆ›å»ºè®¢å•å¹¶è¿”å›æ”¯ä»˜æ•°æ®ï¼ˆäºŒç»´ç /è¡¨å•ï¼‰
   â†“
3. å‰ç«¯å”¤èµ·æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
   â†“
4. ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
5. å‰ç«¯è½®è¯¢æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ (/payment/query)
   â†“
6. åç«¯ç¡®è®¤æ”¯ä»˜æˆåŠŸï¼Œè§¦å‘ä¸šåŠ¡é€»è¾‘ï¼ˆpayment_success_{order_type} é’©å­ï¼‰
   â†“
7. å‰ç«¯æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸé¡µé¢
```

---

## ğŸ“¡ æ¥å£åˆ—è¡¨

### 1. åˆ›å»ºè®¢å•å¹¶å‘èµ·æ”¯ä»˜

**POST** `/wp/v2/payment/create`

åˆ›å»ºè®¢å•å¹¶è·å–æ”¯ä»˜æ•°æ®ï¼ˆäºŒç»´ç ã€H5é“¾æ¥ç­‰ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| type | string | âœ… | è®¢å•ç±»å‹ï¼ˆè§ä¸‹æ–‡ï¼‰ | `donation`, `membership`, `product`, `service`, `recharge` |
| amount | number | âœ… | é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ | `9900` (99å…ƒ) |
| title | string | âœ… | è®¢å•æ ‡é¢˜ï¼ˆæ˜¾ç¤ºåœ¨æ”¯ä»˜é€šé“ï¼‰ | `"iPhone 15 Pro"` |
| method | string | âœ… | æ”¯ä»˜æ–¹å¼ | `alipay`, `wechat` |
| device | string | âœ… | è®¾å¤‡ç±»å‹ | `web`, `wap`, `app`, `scan`, `mini`, `mp` |
| remark | string | âŒ | å¤‡æ³¨ä¿¡æ¯ | `"å¿«é€Ÿå‘è´§"` |
| **ä¸šåŠ¡å­—æ®µ** | any | âŒ | æ ¹æ®è®¢å•ç±»å‹è‡ªå®šä¹‰å­—æ®µï¼ˆæ‰å¹³ä¼ é€’ï¼‰ | `product_id`, `plan_id` ç­‰ |

#### è®¢å•ç±»å‹è¯´æ˜

| ç±»å‹ | type å€¼ | è¯´æ˜ | å¸¸ç”¨ä¸šåŠ¡å­—æ®µ |
|------|---------|------|-------------|
| æ‰“èµ | `donation` | ç”¨æˆ·æ‰“èµ | `from_user_id`, `to_user_id` |
| ä¼šå‘˜è®¢é˜… | `membership` | ä¼šå‘˜å……å€¼ | `plan_id`, `duration_months`, `level` |
| å•†å“è´­ä¹° | `product` | å®ä½“/è™šæ‹Ÿå•†å“ | `product_id`, `quantity`, `sku` |
| æœåŠ¡é¢„è®¢ | `service` | é¢„çº¦æœåŠ¡ | `service_id`, `provider_id`, `scheduled_time` |
| ä½™é¢å……å€¼ | `recharge` | è´¦æˆ·å……å€¼ | `balance_type`, `bonus_amount` |

#### è®¾å¤‡ç±»å‹è¯´æ˜

- `web`: PCç½‘é¡µæ”¯ä»˜
- `wap`: H5æ‰‹æœºç½‘é¡µæ”¯ä»˜
- `app`: APPå†…æ”¯ä»˜
- `scan`: æ‰«ç æ”¯ä»˜
- `mini`: å°ç¨‹åºæ”¯ä»˜
- `mp`: å…¬ä¼—å·æ”¯ä»˜

#### è¯·æ±‚ç¤ºä¾‹

**ä¼šå‘˜è®¢é˜…ï¼š**
```http
POST /wp/v2/payment/create
Content-Type: application/json

{
  "type": "membership",
  "amount": 9900,
  "title": "VIPå¹´åº¦ä¼šå‘˜",
  "method": "wechat",
  "device": "wap",
  "plan_id": 3,
  "duration_months": 12,
  "level": "vip",
  "remark": ""
}
```

**å•†å“è´­ä¹°ï¼š**
```http
POST /wp/v2/payment/create
Content-Type: application/json

{
  "type": "product",
  "amount": 29900,
  "title": "iPhone 15 Pro",
  "method": "alipay",
  "device": "wap",
  "product_id": 123,
  "quantity": 1,
  "sku": "black-256gb",
  "remark": "å¿«é€Ÿå‘è´§"
}
```

**é‡è¦è¯´æ˜ï¼š**
- âœ… æ‰€æœ‰å­—æ®µæ‰å¹³åŒ–ä¼ é€’ï¼Œæ— éœ€åµŒå¥—
- âœ… ä¸šåŠ¡å­—æ®µï¼ˆå¦‚ product_idï¼‰ç›´æ¥ä¼ é€’
- âœ… è‡ªåŠ¨ä¿å­˜ä¸º post_meta

#### è¿”å›æ•°æ®

**æˆåŠŸå“åº”** (code: 0)

```json
{
  "code": 0,
  "message": "success",
  "data": "<form>...æ”¯ä»˜è¡¨å•...</form>"
}
```

**æ”¯ä»˜å®WAPæ”¯ä»˜**ï¼šè¿”å›HTML formè¡¨å•
**æ”¯ä»˜å®æ‰«ç æ”¯ä»˜**ï¼šè¿”å›äºŒç»´ç URL
**å¾®ä¿¡æ”¯ä»˜**ï¼šè¿”å›æ”¯ä»˜å‚æ•°å¯¹è±¡

**å¤±è´¥å“åº”**

```json
{
  "code": 1,
  "message": "æ— æ•ˆå‚æ•°ï¼šdevice",
  "data": ""
}
```

---

### 2. æŸ¥è¯¢æ”¯ä»˜ç»“æœ

**POST** `/wp/v2/payment/find`

æŸ¥è¯¢è®¢å•åœ¨æ”¯ä»˜é€šé“çš„æ”¯ä»˜çŠ¶æ€ï¼ˆä¸è§¦å‘ä¸šåŠ¡é€»è¾‘ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| method | string | âœ… | æ”¯ä»˜æ–¹å¼ï¼š`alipay`, `wechat` |
| out_trade_no | string | âœ… | è®¢å•å·ï¼ˆåˆ›å»ºè®¢å•æ—¶è¿”å›ï¼‰ |

#### è¯·æ±‚ç¤ºä¾‹

```http
POST /wp/v2/payment/find
Content-Type: application/json

{
  "method": "alipay",
  "out_trade_no": "202512120922220066756"
}
```

#### è¿”å›æ•°æ®

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "trade_status": "TRADE_SUCCESS",
    "total_amount": "99.00",
    ...
  }
}
```

---

### 3. ç¡®è®¤æ”¯ä»˜å¹¶è§¦å‘ä¸šåŠ¡é€»è¾‘

**POST** `/wp/v2/payment/query`

æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœå·²æ”¯ä»˜åˆ™è§¦å‘å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå‘è´§ã€å¼€é€šæœåŠ¡ç­‰ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| method | string | âœ… | æ”¯ä»˜æ–¹å¼ï¼š`alipay`, `wechat` |
| out_trade_no | string | âœ… | è®¢å•å· |

#### è¯·æ±‚ç¤ºä¾‹

```http
POST /wp/v2/payment/query
Content-Type: application/json

{
  "method": "alipay",
  "out_trade_no": "202512120922220066756"
}
```

#### è¿”å›æ•°æ®

```json
{
  "code": 0,
  "message": "è®¢å•æ”¯ä»˜æˆåŠŸ",
  "data": true
}
```

**æœªæ”¯ä»˜**ï¼š
```json
{
  "code": 0,
  "message": "è®¢å•æœªæ”¯ä»˜",
  "data": false
}
```

---

## ğŸ¯ ä¸šåŠ¡åœºæ™¯å®Œæ•´ç¤ºä¾‹

### 1. ä¼šå‘˜è®¢é˜…ï¼ˆMembershipï¼‰

**åœºæ™¯**: ç”¨æˆ·è´­ä¹° VIP ä¼šå‘˜

**è¯·æ±‚å‚æ•°**:
```json
{
  "type": "membership",
  "amount": 9900,
  "title": "VIPå¹´åº¦ä¼šå‘˜",
  "method": "wechat",
  "device": "wap",
  "plan_id": 3,
  "duration_months": 12,
  "level": "vip"
}
```

**æ”¯ä»˜æˆåŠŸåè§¦å‘**:
- Hook: `payment_success_membership`
- ä¸šåŠ¡é€»è¾‘: è‡ªåŠ¨å¼€é€šä¼šå‘˜ã€è®¾ç½®è¿‡æœŸæ—¶é—´ã€å åŠ æœŸé™ï¼ˆç»­è´¹ï¼‰

---

### 2. å•†å“è´­ä¹°ï¼ˆProductï¼‰

**åœºæ™¯**: ç”¨æˆ·è´­ä¹°å®ä½“å•†å“

**è¯·æ±‚å‚æ•°**:
```json
{
  "type": "product",
  "amount": 29900,
  "title": "iPhone 15 Pro",
  "method": "alipay",
  "device": "wap",
  "product_id": 123,
  "quantity": 1,
  "sku": "black-256gb",
  "shipping_address": "åŒ—äº¬å¸‚æœé˜³åŒºxxx",
  "remark": "å¿«é€Ÿå‘è´§"
}
```

**æ”¯ä»˜æˆåŠŸåè§¦å‘**:
- Hook: `payment_success_product`
- ä¸šåŠ¡é€»è¾‘: å‡åº“å­˜ã€ç”Ÿæˆå‘è´§å•ã€å‘é€é€šçŸ¥

---

### 3. æœåŠ¡é¢„è®¢ï¼ˆServiceï¼‰

**åœºæ™¯**: ç”¨æˆ·é¢„çº¦è®¾è®¡æœåŠ¡

**è¯·æ±‚å‚æ•°**:
```json
{
  "type": "service",
  "amount": 50000,
  "title": "UIè®¾è®¡æœåŠ¡",
  "method": "wechat",
  "device": "wap",
  "service_id": 789,
  "provider_id": 12,
  "scheduled_time": "2025-12-25 14:00",
  "requirements": "éœ€è¦3ä¸ªé¡µé¢"
}
```

**æ”¯ä»˜æˆåŠŸåè§¦å‘**:
- Hook: `payment_success_service`
- ä¸šåŠ¡é€»è¾‘: åˆ›å»ºæœåŠ¡å·¥å•ã€é€šçŸ¥æœåŠ¡æä¾›è€…

---

### 4. ä½™é¢å……å€¼ï¼ˆRechargeï¼‰

**åœºæ™¯**: ç”¨æˆ·è´¦æˆ·å……å€¼

**è¯·æ±‚å‚æ•°**:
```json
{
  "type": "recharge",
  "amount": 10000,
  "title": "è´¦æˆ·å……å€¼",
  "method": "alipay",
  "device": "wap",
  "balance_type": "main",
  "bonus_amount": 500
}
```

**æ”¯ä»˜æˆåŠŸåè§¦å‘**:
- Hook: `payment_success_recharge`
- ä¸šåŠ¡é€»è¾‘: å¢åŠ ä½™é¢ã€èµ é€å¥–åŠ±é‡‘

---

### 5. æ‰“èµï¼ˆDonationï¼‰

**åœºæ™¯**: ç”¨æˆ·æ‰“èµä½œè€…ï¼ˆFans é¡¹ç›®ï¼‰

**ç‰¹æ®Šè¯´æ˜**: æ‰“èµä½¿ç”¨ä¸“ç”¨æ¥å£ `/wp/v2/donation/create`ï¼ˆå‘åå…¼å®¹ï¼‰

**è¯·æ±‚å‚æ•°**:
```json
{
  "amount": 500,
  "method": "wechat",
  "to_user_id": 20,
  "remark": "å†™å¾—çœŸå¥½ï¼"
}
```

**æ”¯ä»˜æˆåŠŸåè§¦å‘**:
- Hook: `payment_success_donation`
- ä¸šåŠ¡é€»è¾‘: ç”Ÿæˆæ‰“èµè®°å½•ã€åŠ å…¥æ‰“æ¬¾é˜Ÿåˆ—

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é‡‘é¢å•ä½

**æ‰€æœ‰é‡‘é¢éƒ½æ˜¯ä»¥åˆ†ä¸ºå•ä½ï¼**

```javascript
// âœ… æ­£ç¡®
amount: 9900  // è¡¨ç¤º99å…ƒ

// âŒ é”™è¯¯
amount: 99    // ä¼šè¢«ç†è§£ä¸º0.99å…ƒ
```

### 2. å‚æ•°æ‰å¹³åŒ–

**ä¸å†éœ€è¦ custom_meta åµŒå¥—ï¼**

```javascript
// âœ… æ­£ç¡®ï¼ˆæ–°ç‰ˆï¼‰
{
  "type": "membership",
  "amount": 1500,
  "title": "VIPä¼šå‘˜",
  "plan_id": 2,
  "duration_months": 3
}

// âŒ é”™è¯¯ï¼ˆæ—§ç‰ˆï¼‰
{
  "type": "membership",
  "amount": 1500,
  "name": "VIPä¼šå‘˜",
  "custom_meta": {
    "plan_id": 2,
    "duration_months": 3
  }
}
```

### 3. å­—æ®µå‘½å

- âœ… ä½¿ç”¨ `title`ï¼ˆè®¢å•æ ‡é¢˜ï¼‰
- âŒ ä¸è¦ä½¿ç”¨ `name`

### 4. è®¾å¤‡ç±»å‹

å¿…é¡»ä½¿ç”¨è§„å®šçš„è®¾å¤‡ç±»å‹ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯ï¼š

æœ‰æ•ˆå€¼ï¼š`web`, `wap`, `app`, `scan`, `mini`, `mp`

### 5. ç”¨æˆ·èº«ä»½

- **ç™»å½•ç”¨æˆ·**ï¼šè®¢å•ä¼šè‡ªåŠ¨è®°å½•ç”¨æˆ·IDï¼ˆ`post_author`ï¼‰
- **æ¸¸å®¢**ï¼š`post_author = 0`

å‰ç«¯æ— éœ€ä¼ é€’ `buyer_id` å‚æ•°ï¼Œåç«¯ä¼šè‡ªåŠ¨è·å–å½“å‰ç™»å½•ç”¨æˆ·ã€‚

### 6. è½®è¯¢é¢‘ç‡

å»ºè®®è½®è¯¢é—´éš”ï¼š**3-5ç§’**ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚

### 7. è¶…æ—¶å¤„ç†

å»ºè®®è½®è¯¢è¶…æ—¶æ—¶é—´ï¼š**5åˆ†é’Ÿ**ï¼Œè¶…æ—¶ååœæ­¢è½®è¯¢å¹¶æç¤ºç”¨æˆ·

---

## ğŸ”§ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| code | message | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|------|---------|
| 1 | æ— æ•ˆå‚æ•°ï¼šdevice | deviceå€¼ä¸åœ¨æšä¸¾ä¸­ | ä½¿ç”¨æœ‰æ•ˆçš„è®¾å¤‡ç±»å‹ |
| 1 | rest_missing_callback_param | ç¼ºå°‘å¿…å¡«å‚æ•° | æ£€æŸ¥æ‰€æœ‰å¿…å¡«å‚æ•° |
| 1 | è®¢å•ä¸å­˜åœ¨ | è®¢å•å·é”™è¯¯ | æ£€æŸ¥è®¢å•å·æ˜¯å¦æ­£ç¡® |
| 1 | è®¢å•æœªæ”¯ä»˜ | ç”¨æˆ·æœªå®Œæˆæ”¯ä»˜ | ç»§ç»­è½®è¯¢æˆ–æç¤ºç”¨æˆ· |

### é”™è¯¯å¤„ç†å»ºè®®

1. **åŒºåˆ†ä¸šåŠ¡é”™è¯¯å’Œç½‘ç»œé”™è¯¯**
   - ä¸šåŠ¡é”™è¯¯ï¼š`result.code !== 0`ï¼Œæ˜¾ç¤º `result.message`
   - ç½‘ç»œé”™è¯¯ï¼šè¯·æ±‚å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œ

2. **å…³é”®é”™è¯¯éœ€è¦æç¤ºç”¨æˆ·**
   - å‚æ•°é”™è¯¯ï¼šæç¤ºç”¨æˆ·ä¿®æ­£è¾“å…¥
   - è®¢å•åˆ›å»ºå¤±è´¥ï¼šæç¤ºç”¨æˆ·é‡è¯•
   - æ”¯ä»˜è¶…æ—¶ï¼šå¼•å¯¼ç”¨æˆ·é‡æ–°å‘èµ·æ”¯ä»˜

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- åç«¯æ—¥å¿—ï¼š`wp-content/debug.log`
- æ”¯ä»˜é€šé“æ–‡æ¡£ï¼š[æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://opendocs.alipay.com/)ã€[å¾®ä¿¡æ”¯ä»˜æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/api/)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.1.0 (2025-12-12)
- âœ… ç§»é™¤å†—ä½™çš„ `buyer_id` å‚æ•°
- âœ… è‡ªåŠ¨è·å–å½“å‰ç™»å½•ç”¨æˆ·
- âœ… ä¼˜åŒ–å‚æ•°è®¾è®¡

### v1.0.0 (2025-12-10)
- âœ… åˆå§‹ç‰ˆæœ¬
- âœ… æ”¯æŒæ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
- âœ… æ”¯æŒå¤šè®¾å¤‡ç±»å‹
