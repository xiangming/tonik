# 前端支付接入文档

## 📌 概述

本文档提供通用支付接口的技术规范，适用于所有需要支付功能的项目（商城、服务、打赏、会员等）。

**API Base URL**: `http://wp.local/api` (生产环境需替换为实际域名)

---

## 🔄 完整支付流程

```
1. 前端调用创建订单接口 (/payment/create)
   ↓
2. 后端创建订单并返回支付数据（二维码/表单）
   ↓
3. 前端唤起支付宝/微信支付
   ↓
4. 用户完成支付
   ↓
5. 前端轮询查询支付状态 (/payment/query)
   ↓
6. 后端确认支付成功，触发业务逻辑（payment_success_{order_type} 钩子）
   ↓
7. 前端显示支付成功页面
```

---

## 📡 接口列表

### 1. 创建订单并发起支付

**POST** `/wp/v2/payment/create`

创建订单并获取支付数据（二维码、H5链接等）

#### 请求参数

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| order_type | string | ✅ | 订单类型，由各项目自定义 | `product`, `service`, `donation`, `membership` |
| amount | number | ✅ | 金额（单位：分） | `9900` (99元) |
| name | string | ✅ | 订单标题（显示在支付通道） | `"iPhone 15 Pro"` |
| method | string | ✅ | 支付方式 | `alipay`, `wechat` |
| device | string | ✅ | 设备类型 | `web`, `wap`, `app`, `scan`, `mini`, `mp` |
| related_id | number | ❌ | 关联ID（如：商品ID、服务ID） | `123` |
| remark | string | ❌ | 备注信息 | `"快速发货"` |

#### 设备类型说明

- `web`: PC网页支付
- `wap`: H5手机网页支付
- `app`: APP内支付
- `scan`: 扫码支付
- `mini`: 小程序支付
- `mp`: 公众号支付

#### 请求示例

```http
POST /wp/v2/payment/create
Content-Type: application/json

{
  "order_type": "product",
  "amount": 9900,
  "name": "iPhone 15 Pro",
  "method": "alipay",
  "device": "wap",
  "related_id": 123,
  "remark": "快速发货"
}
```

#### 返回数据

**成功响应** (code: 0)

```json
{
  "code": 0,
  "message": "success",
  "data": "<form>...支付表单...</form>"
}
```

**支付宝WAP支付**：返回HTML form表单
**支付宝扫码支付**：返回二维码URL
**微信支付**：返回支付参数对象

**失败响应**

```json
{
  "code": 1,
  "message": "无效参数：device",
  "data": ""
}
```

---

### 2. 查询支付结果

**POST** `/wp/v2/payment/find`

查询订单在支付通道的支付状态（不触发业务逻辑）

#### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| method | string | ✅ | 支付方式：`alipay`, `wechat` |
| out_trade_no | string | ✅ | 订单号（创建订单时返回） |

#### 请求示例

```http
POST /wp/v2/payment/find
Content-Type: application/json

{
  "method": "alipay",
  "out_trade_no": "202512120922220066756"
}
```

#### 返回数据

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "trade_status": "TRADE_SUCCESS",
    "total_amount": "99.00",
    ...
  }
}
```

---

### 3. 确认支付并触发业务逻辑

**POST** `/wp/v2/payment/query`

检查支付状态，如果已支付则触发对应的业务逻辑（发货、开通服务等）

#### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| method | string | ✅ | 支付方式：`alipay`, `wechat` |
| out_trade_no | string | ✅ | 订单号 |

#### 请求示例

```http
POST /wp/v2/payment/query
Content-Type: application/json

{
  "method": "alipay",
  "out_trade_no": "202512120922220066756"
}
```

#### 返回数据

```json
{
  "code": 0,
  "message": "订单支付成功",
  "data": true
}
```

**未支付**：
```json
{
  "code": 0,
  "message": "订单未支付",
  "data": false
}
```

---

## 🎯 业务场景示例

### 商城项目 - 商品购买

**order_type**: `product`

**请求参数**:
- `related_id`: 商品ID
- `remark`: 商品规格（如：黑色 256GB）

**后端处理**: 监听 `payment_success_product` 钩子，执行减库存、增加销量、创建发货单等操作

---

### 服务预订

**order_type**: `service`

**请求参数**:
- `related_id`: 服务ID
- `remark`: 预约时间等信息

**后端处理**: 监听 `payment_success_service` 钩子，创建预约记录、发送服务通知

---

### 会员充值

**order_type**: `membership`

**请求参数**:
- `related_id`: 用户ID（可选）
- `amount`: 会员套餐金额

**后端处理**: 监听 `payment_success_membership` 钩子，延长会员到期时间、开通会员权益

---

### Fans 打赏

**专用接口**: `/wp/v2/payment/donation`

Fans 项目已有专用打赏接口，参数包含 `to`（被打赏人ID）、`amount`、`method`、`device`、`remark`

---

## ⚠️ 注意事项

### 1. 金额单位

**所有金额都是以分为单位！**

```javascript
// ✅ 正确
amount: 9900  // 表示99元

// ❌ 错误
amount: 99    // 会被理解为0.99元
```

### 2. 设备类型

必须使用规定的设备类型，否则会返回错误：

```javascript
// ✅ 正确
device: 'wap'

// ❌ 错误
device: 'h5'  // 返回：无效参数：device
```

有效值：`web`, `wap`, `app`, `scan`, `transfer`, `mini`, `mp`, `pos`

### 3. 订单类型

`order_type` 由各项目自定义，建议使用语义化命名：

- ✅ 推荐：`product`, `service`, `membership`, `donation`
- ❌ 不推荐：`type1`, `pay`, `order`

### 4. 用户身份

- **登录用户**：订单会自动记录用户ID（`post_author`）
- **游客**：`post_author = 0`

前端无需传递 `buyer_id` 参数，后端会自动获取当前登录用户。

### 5. 轮询频率

建议轮询间隔：**3-5秒**，避免过于频繁的请求

### 6. 超时处理

建议轮询超时时间：**5分钟**，超时后停止轮询并提示用户

---

## 🔧 错误处理

### 常见错误码

| code | message | 原因 | 解决方案 |
|------|---------|------|---------|
| 1 | 无效参数：device | device值不在枚举中 | 使用有效的设备类型 |
| 1 | rest_missing_callback_param | 缺少必填参数 | 检查所有必填参数 |
| 1 | 订单不存在 | 订单号错误 | 检查订单号是否正确 |
| 1 | 订单未支付 | 用户未完成支付 | 继续轮询或提示用户 |

### 错误处理建议

1. **区分业务错误和网络错误**
   - 业务错误：`result.code !== 0`，显示 `result.message`
   - 网络错误：请求失败，提示用户检查网络

2. **关键错误需要提示用户**
   - 参数错误：提示用户修正输入
   - 订单创建失败：提示用户重试
   - 支付超时：引导用户重新发起支付

---

## 📞 技术支持

如有问题，请查看：
- 后端日志：`wp-content/debug.log`
- 支付通道文档：[支付宝开放平台](https://opendocs.alipay.com/)、[微信支付文档](https://pay.weixin.qq.com/wiki/doc/api/)

---

## 📝 更新日志

### v1.1.0 (2025-12-12)
- ✅ 移除冗余的 `buyer_id` 参数
- ✅ 自动获取当前登录用户
- ✅ 优化参数设计

### v1.0.0 (2025-12-10)
- ✅ 初始版本
- ✅ 支持支付宝/微信支付
- ✅ 支持多设备类型
