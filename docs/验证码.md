# 验证码

基于原来 yuancheng 里面用的那套验证码逻辑，我们进行了重构和优化。

## 原来的逻辑

主邮箱，辅手机。必须先使用邮箱注册，再绑定手机。

- 短信和邮箱都使用 code
- 手机使用 phone_temp，验证通过后转正为 phone
- 默认使用真实邮箱注册，并使用 activate 字段来标志邮箱是否已经验证

### 存在的问题

用户填写假邮箱，也能使用我们的服务。产生的垃圾数据，永远不会被发现清理。

用户必须先使用邮箱注册，不能直接使用手机注册。

## 优化后的逻辑

邮箱和手机同级，没有先后要求，都能直接用于注册。

没有验证过的邮箱或者手机不能直接用于登录，只能通过验证码登录。

定期清理没有验证的账号:

```php
$uid = getUserByMeta('phone_temp');
if (get_user_meta($uid, 'phone')) {
  delete_user_meta($uid, 'phone_temp'); // 删除冗余字段
} else {
  delete $uid; // 删除无效用户
}
```

## 可能的优化方向

短信和邮箱验证码互相覆盖，做不到独立。

区分短信验证码和邮箱验证码：

- 默认使用 hash 值注册，用户没有验证过的手机号和邮箱，不能用于登录
- 短信验证码使用 phone_temp 和 phone_code
- 邮箱验证码使用 email_temp 和 email_code
